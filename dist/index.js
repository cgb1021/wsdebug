import _asyncToGenerator from"@babel/runtime/helpers/asyncToGenerator";import _typeof from"@babel/runtime/helpers/typeof";import _regeneratorRuntime from"@babel/runtime/regenerator";!function(e,t){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?t(exports,require("espree")):"function"==typeof define&&define.amd?define(["exports","espree"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).wsdebug={},e.espree)}(this,function(exports,espree){"use strict";function _interopNamespace(r){if(r&&r.__esModule)return r;var n=Object.create(null);return r&&Object.keys(r).forEach(function(e){var t;"default"!==e&&(t=Object.getOwnPropertyDescriptor(r,e),Object.defineProperty(n,e,t.get?t:{enumerable:!0,get:function(){return r[e]}}))}),n.default=r,Object.freeze(n)}var espree__namespace=_interopNamespace(espree),protocol={script:"script://",result:"result://",connect:"connect://",query:"query://",live:"live://",close:"close://",id:"id://",role:"role://",error:"error://",version:"version://",route:"route://",sid:"sid://"},idReg="(?:([\\w-]+)/)?(.+)$",_require=require("../package.json"),version=_require.version;function idSplit(e,r){var n=[];return e&&e.split(",").map(function(e){var t={name:e};"master"===r&&(e=e.split(":"),t.name=e[0],t.list=e[1]?e[1].split("|"):[]),n.push(t)}),n}function Base(e,t,r,n,o){var s,c=this;switch(arguments.length){case 4:n=0;break;case 3:r=!("object"===_typeof(r)||!r);break;case 2:"object"===_typeof(arguments[0])?(void 0!==(s=arguments[0]).host&&(e=s.host),void 0!==s.port&&(t=s.port),void 0!==s.ssl&&(r=s.ssl),"function"==typeof s.onerror&&(o=s.onerror),void 0!==s.timeout&&(n=s.timeout)):t=0;break;case 1:e=""}var i=arguments[arguments.length-1],a=i.connectedCallbacks,u=i.role,l=i.onmessage,p={},f=[],d=[],h="",m=0,v=0;t=t||(r?443:8081),this.name="",this.password="";var y=new WebSocket("".concat(r?"wss":"ws","://").concat(e||"127.0.0.1",":").concat(t,"/websocket"));y.addEventListener("error",function(e){"function"==typeof o?o(e):console.error(e.message||"websocket error")}),y.addEventListener("open",function(){n&&0<n&&(m=window.setInterval(function(){return c.send("".concat(protocol.live,"1"))},1e3*n)),c.setRole().catch(function(){}),f.length&&(f.forEach(function(e){var t=e.msg,e=e.id;return y.send("".concat(t,"#").concat(e))}),f.length=0)}),y.addEventListener("close",function(){m=m&&window.clearInterval(m)}),y.addEventListener("message",function(e){var t,r,n=e.data,o=n.match(/#(\w+)$/),e=n.replace(/#\w+$/,""),n=o?o[1]:"";e.indexOf(protocol.sid)?e.indexOf(protocol.connect)?(n&&void 0!==p[n]&&(o=p[n],window.clearTimeout(o.timeoutId),-1<e.indexOf(protocol.error)?o.reject(new Error(e.substr(protocol.error.length))):o.resolve(e),delete p[n]),l({data:e,id:n})):(n=e.substr(protocol.connect.length).split("/"),t=idSplit(n[0],u),r=1<n.length?+n[1]:void 0,a.forEach(function(e){return e(t,r)})):h=e.substr(protocol.sid.length)}),this.role=function(){return u},this.url=function(){return y.url},this.sessionId=function(){return h},this.readyState=function(){return y.readyState},this.setRole=function(){return this.send2("".concat(protocol.role).concat(u,"/").concat(this.name,":").concat(this.password)).then(function(e){return e.substr(protocol.role.length)===u})},this.on=function(e,t,r){var n;"connect"===e?"function"==typeof t?(n=a.indexOf(t),r||-1!==n||a.push(t),r&&-1<n&&a.splice(n,1)):a.length=0:r?y.removeEventListener(e,t):y.addEventListener(e,t)},this.send=function(e){if(1<y.readyState)return"";var t="".concat(Date.now()).concat(v++);return y.readyState||f.push({msg:e,id:t}),1===y.readyState&&y.send("".concat(e,"#").concat(t)),t},this.send2=function(e,n){var o=this.send(e);return new Promise(function(e,t){var r;o?(r=window.setTimeout(function(){delete p[o],t(new Error("Timeout"))},n&&0<n?1e3*n:5e3),p[o]={resolve:e,reject:t,timeoutId:r}):t(new Error("Close"))})},this.close=function(){y&&y.close()},this.setId=function(e){var r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1;e?e.split(",").forEach(function(e){var t;e&&/^[\w,.-]+$/.test(e)&&(t=d.indexOf(e),r&&-1===t?d.push(e):!r&&-1<t&&d.splice(t,1))}):d.length=0,this.send("".concat(protocol.id).concat(d.length?d.join(","):"*"))},this.getId=function(){return d}}function Client(){var _this3=this,onerror=4<arguments.length&&"function"==typeof arguments[4]?arguments[4]:"object"===_typeof(arguments[0])&&"function"==typeof arguments[0].onerror?arguments[0].onerror:null,funcMap={},context=null,data={connectedCallbacks:[],role:"client",onmessage:function onmessage(_ref4){var data=_ref4.data,id=_ref4.id,_result;if(data.indexOf(protocol.script)){data.indexOf(protocol.error)||(_result=data.substr(protocol.error.length),onerror?onerror(new Error(_result||"unknow error")):console.error(_result))}else{var reg=new RegExp("^".concat(protocol.script).concat(idReg)),match=data.match(reg);if(match){var sid=match[1],script=match[2],result=void 0,send=function(e,t){var r="",r=e?"".concat(protocol.error).concat(e.message||"error"):"".concat(protocol.result).concat(JSON.stringify(t));_this3.send("".concat(protocol.route).concat(sid,"/").concat(r,"#").concat(id))},bCalled=!1;try{var res=espree__namespace.parse(script),fnName,func,getValue,args;res.body.length&&res.body[0].expression.callee&&res.body[0].expression.callee.name&&(fnName=res.body[0].expression.callee.name,func=funcMap[fnName]||("function"==typeof window[fnName]?window[fnName]:null),func&&(getValue=function t(e){if(void 0!==e.properties){var r={};return e.properties.forEach(function(e){r[e.key.name]=t(e.value)}),r}if(void 0===e.elements)return e.value;var n=[];return e.elements.forEach(function(e){n.push(t(e))}),n},args=[],res.body[0].expression.arguments.forEach(function(e){args.push(getValue(e))}),result=func.apply(context,args),bCalled=!0))}catch(e){}if(!bCalled)try{result=eval(script)}catch(e){return void send(e)}result instanceof Promise?result.then(function(e){return send(null,e)}).catch(send):send(null,result)}}}};Base.apply(this,[].concat(Array.prototype.slice.call(arguments),[data])),this.register=function(e,t){e&&"function"==typeof t&&(funcMap[e]=t)},this.remove=function(e){if("function"!=typeof e)return!!e&&delete funcMap[e];var t,r=0;for(t in funcMap)funcMap[t]===e&&delete funcMap[t]&&r++;return!!r},this.bind=function(e){"object"===_typeof(e)&&(context=e)}}function Master(){var n=4<arguments.length&&"function"==typeof arguments[4]?arguments[4]:"object"===_typeof(arguments[0])&&"function"==typeof arguments[0].onerror?arguments[0].onerror:null,o={},e={connectedCallbacks:[],role:"master",onmessage:function(e){var t=e.data,r=e.id;if(!t.indexOf(protocol.result)){e=t.substr(protocol.result.length);if(e)try{e=JSON.parse(e)}catch(e){}"function"==typeof o[r]?o[r](null,e):o[r]&&n&&n(o[r])}t.indexOf(protocol.error)||(t=t.substr(protocol.error.length),t=new Error(t||"unknow error"),"function"!=typeof o[r]?n?n(t):console.error(t):o[r](t,null))}};Base.apply(this,[].concat(Array.prototype.slice.call(arguments),[e])),this.run=function(e,t,r){var n=this.send("".concat(protocol.script).concat(this.sessionId(),"/").concat(e));n&&"function"==typeof t&&(o[n]=t,setTimeout(function(){o[n]=new Error("RunTimeout")},r&&0<r?1e3*r:9e4))},this.connect=this.setId}Base.prototype.version=function(){var t=_asyncToGenerator(_regeneratorRuntime.mark(function e(t){return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t)return e.abrupt("return",this.send2("".concat(protocol.version,"*")).then(function(e){return e.substr(protocol.version.length)}));e.next=2;break;case 2:return e.abrupt("return",version);case 3:case"end":return e.stop()}},e,this)}));return function(e){return t.apply(this,arguments)}}(),Base.prototype.query=function(){var t=this;return this.send2("".concat(protocol.query,"1")).then(function(e){return idSplit(e.substr(protocol.query.length),t.role())})},Client.prototype=Base.prototype,Master.prototype=Base.prototype,exports.Client=Client,exports.Master=Master,Object.defineProperty(exports,"__esModule",{value:!0})});