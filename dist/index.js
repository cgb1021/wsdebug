function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}!function(e,t){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?t(exports,require("espree")):"function"==typeof define&&define.amd?define(["exports","espree"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).wsdebug={},e.espree)}(this,function(exports,espree){"use strict";function _interopNamespace(o){if(o&&o.__esModule)return o;var r=Object.create(null);return o&&Object.keys(o).forEach(function(e){var t;"default"!==e&&(t=Object.getOwnPropertyDescriptor(o,e),Object.defineProperty(r,e,t.get?t:{enumerable:!0,get:function(){return o[e]}}))}),r.default=o,Object.freeze(r)}var espree__namespace=_interopNamespace(espree),protocol={script:"script://",result:"result://",connect:"connect://",query:"query://",live:"live://",close:"close://",id:"id://",role:"role://",error:"error://"},prototype={close:function(){this.socket.close()},send:function(e){1===this.socket.readyState&&this.socket.send(e)},query:function(){1===this.socket.readyState&&this.socket.send("".concat(protocol.query,"1"))},live:function(){1===this.socket.readyState&&this.socket.send("".concat(protocol.live,"1"))}};function Client(host,port,ssl,onerror){var _this=this,arg;1===arguments.length&&"object"===_typeof(arguments[0])&&(arg=arguments[0],void 0!==arg.host&&(host=arg.host),void 0!==arg.port&&(port=arg.port),void 0!==arg.ssl&&(ssl=arg.ssl),void 0!==arg.onerror&&(onerror=arg.onerror)),port=port||(ssl?443:8081);var url="".concat(ssl?"wss":"ws","://").concat(host||"127.0.0.1",":").concat(port,"/websocket"),context=null,ids=[],funcMap={},connectedCallbacks=[];this.socket=new WebSocket(url),this.socket.addEventListener("error",function(e){"function"==typeof onerror?onerror(e):console.error(e.message||"websocket error")}),this.socket.addEventListener("message",function(_ref){var data=_ref.data,val,str;if(!data.indexOf(protocol.script)){var reg=new RegExp("^".concat(protocol.script,"(?:(\\w+)/)?(.+)$")),match=data.match(reg);if(match){var id=match[1],script=match[2],result=void 0,send=function(e,t){e?(e=e.message||"error",id?_this.socket.send("".concat(protocol.error).concat(id,"/").concat(e)):_this.socket.send("".concat(protocol.error).concat(e))):("object"===_typeof(t)&&(t=JSON.stringify(t)),id?_this.socket.send("".concat(protocol.result).concat(id,"/").concat(t)):_this.socket.send("".concat(protocol.result).concat(t)))};try{var res=espree__namespace.parse(script),bCalled=!1,fnName,func,getValue,args;res.body.length&&res.body[0].expression.callee.name&&(fnName=res.body[0].expression.callee.name,func=funcMap[fnName]||("function"==typeof window[fnName]?window[fnName]:null),func&&(getValue=function t(e){if(void 0!==e.properties){var o={};return e.properties.forEach(function(e){o[e.key.name]=t(e.value)}),o}if(void 0===e.elements)return e.value;var r=[];return e.elements.forEach(function(e){r.push(t(e))}),r},args=[],res.body[0].expression.arguments.forEach(function(e){args.push(getValue(e))}),result=func.apply(context,args),bCalled=!0)),bCalled||(result=eval(script))}catch(e){return console.error(e),void send(e)}result instanceof Promise?result.then(function(e){return send(null,e)}).catch(function(e){console.error(e),send(e)}):send(null,result)}}data.indexOf(protocol.connect)||(val=data.substr(protocol.connect.length),connectedCallbacks.forEach(function(e){e(val)})),data.indexOf(protocol.id)||(str=data.substr(protocol.id.length),ids=str?str.split(","):[]),data.indexOf(protocol.error)||console.error(data.substr(protocol.error.length))}),this.bind=function(e){e&&"object"===_typeof(e)&&(context=e)},this.register=function(e,t){"function"==typeof t&&(funcMap[e]=t)},this.setId=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1;1===this.socket.readyState&&e&&/^\w+$/.test(e)&&(t=1===t?1:0,this.socket.send("".concat(protocol.id).concat(e,":").concat(t)))},this.getId=function(){return ids},this.on=function(e,t,o){var r;"connect"===e?"function"==typeof t&&(r=connectedCallbacks.indexOf(t),o||-1!==r||connectedCallbacks.push(t),o&&-1<r&&connectedCallbacks.splice(r,1)):o?this.socket.removeEventListener(e,t):this.socket.addEventListener(e,t)}}function Master(e,t,o,r){var n,c=this;1===arguments.length&&"object"===_typeof(arguments[0])&&(void 0!==(n=arguments[0]).host&&(e=n.host),void 0!==n.port&&(t=n.port),void 0!==n.ssl&&(o=n.ssl),void 0!==n.onerror&&(r=n.onerror)),t=t||(o?443:80);var t="".concat(o?"wss":"ws","://").concat(e||"127.0.0.1",":").concat(t,"/websocket"),s={},a=[];this.socket=new WebSocket(t),this.socket.addEventListener("error",function(e){"function"==typeof r?r(e):console.error(e.message||"websocket error")}),this.socket.addEventListener("open",function(){c.socket.send("".concat(protocol.role,"master"))}),this.socket.addEventListener("message",function(e){var t,o=e.data;if(o.indexOf(protocol.result)||(e=new RegExp("^".concat(protocol.result,"(?:(\\w+)/)?(.+)$")),(t=o.match(e))&&((e=t[1])&&s[e]?s[e](t[2]):c.receive(t[2]))),!o.indexOf(protocol.connect)){var r=new Array(2);try{r=o.substr(protocol.connect.length).split("/")}catch(e){console.error(e)}a.forEach(function(e){e({id:r[0],value:r[1]})})}o.indexOf(protocol.error)||(t=new RegExp("^".concat(protocol.error,"(?:(\\w+)/)?(.+)$")),t=o.match(t),o=o.substr(protocol.error.length),!t||(t=t[1])&&s[t]&&s[t](null,new Error(o)),console.error(o))}),this.run=function(e,t){var o;1===this.socket.readyState&&("function"==typeof t?(o=100*Date.now()+Math.floor(100*Math.random()),s[o]=t,this.socket.send("".concat(protocol.script).concat(o,"/").concat(e)),setTimeout(function(){delete s[o]},3e5)):this.socket.send("".concat(protocol.script).concat(e)))},this.connect=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1;1===this.socket.readyState&&e&&(t=1===t?1:0,this.socket.send("".concat(protocol.id).concat(e,":").concat(t)))},this.on=function(e,t,o){var r;"connect"===e?"function"==typeof t&&(r=a.indexOf(t),o||-1!==r||a.push(t),o&&-1<r&&a.splice(r,1)):o?this.socket.removeEventListener(e,t):this.socket.addEventListener(e,t)}}Object.assign(Client.prototype,prototype),Object.assign(Master.prototype,prototype),Master.prototype.receive=function(e){console.log("receive",e)},exports.Client=Client,exports.Master=Master,Object.defineProperty(exports,"__esModule",{value:!0})});