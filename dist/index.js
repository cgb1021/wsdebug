function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}!function(e,t){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?t(exports,require("espree")):"function"==typeof define&&define.amd?define(["exports","espree"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).wsdebug={},e.espree)}(this,function(exports,espree){"use strict";function _interopNamespace(o){if(o&&o.__esModule)return o;var n=Object.create(null);return o&&Object.keys(o).forEach(function(e){var t;"default"!==e&&(t=Object.getOwnPropertyDescriptor(o,e),Object.defineProperty(n,e,t.get?t:{enumerable:!0,get:function(){return o[e]}}))}),n.default=o,Object.freeze(n)}var espree__namespace=_interopNamespace(espree),protocol={script:"script://",result:"result://",connect:"connect://",query:"query://",live:"live://",close:"close://",id:"id://",role:"role://",error:"error://",version:"version://",route:"route://",sid:"sid://"},idReg="(?:([\\w-]+)/)?(.+)$",_require=require("../package.json"),version=_require.version;function Base(e,t,o,n,r){var s,c=this;switch(arguments.length){case 4:n=0;break;case 3:o=!0;break;case 2:"object"===_typeof(arguments[0])?(void 0!==(s=arguments[0]).host&&(e=s.host),void 0!==s.port&&(t=s.port),void 0!==s.ssl&&(o=s.ssl),"function"==typeof s.onerror&&(r=s.onerror),void 0!==s.timeout&&(n=s.timeout)):t=0;break;case 1:e=""}var i=arguments[arguments.length-1],a=i.connectedCallbacks,u=i.type,l=i.onmessage,f={};t=t||(o?443:8081);var i="".concat(o?"wss":"ws","://").concat(e||"127.0.0.1",":").concat(t,"/websocket"),p=[],d="",y=0;this.name="",this.password="";var h=new WebSocket(i),m=0;h.addEventListener("error",function(e){"function"==typeof r?r(e):console.error(e.message||"websocket error")}),h.addEventListener("open",function(){c.send("".concat(protocol.role).concat(u,"/").concat(c.name,":").concat(c.password)),n&&0<n&&(y=window.setInterval(function(){return c.send("".concat(protocol.live,"1"))},1e3*n))}),h.addEventListener("close",function(){y=y&&window.clearInterval(y)}),h.addEventListener("message",function(e){var t=e.data,o=t.match(/#(\w+)$/),e=t.replace(/#\w+$/,""),t=o?o[1]:"";if(e.indexOf(protocol.sid))if(e.indexOf(protocol.connect))t&&void 0!==f[t]&&(o=f[t],window.clearTimeout(o.timeoutId),o.resolve(e),delete f[t]),l({data:e,id:t});else{var n=[""];try{n=e.substr(protocol.connect.length).split("/")}catch(e){console.error(e)}a.forEach(function(e){return e(n[0]?n[0].split(",").map(function(e){if("master"!==u)return{name:e,list:[]};e=e.split(":");return{name:e[0],list:e[1]?e[1].split("|"):[]}}):[],1<n.length?+n[1]:void 0)})}else d=e.substr(protocol.sid.length)}),this.on=function(e,t,o){var n;"connect"===e?"function"==typeof t?(n=a.indexOf(t),o||-1!==n||a.push(t),o&&-1<n&&a.splice(n,1)):a.length=0:o?h.removeEventListener(e,t):h.addEventListener(e,t)},this.send=function(e){var t="";return h&&1===h.readyState&&(t="".concat(Date.now()).concat(m++),h.send("".concat(e,"#").concat(t))),t},this.send2=function(e,n){var r=this.send(e);return new Promise(function(e,t){var o;r?(o=window.setTimeout(function(){delete f[r],t()},n&&0<n?1e3*n:5e3),f[r]={resolve:e,timeoutId:o}):e(r)})},this.sessionId=function(){return d},this.close=function(){h&&h.close()},this.readyState=function(){return h.readyState},this.setId=function(e){var o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1,e=e.split(",");e.length&&e[0]?e.forEach(function(e){var t;/^[\w,.-]+$/.test(e)&&(t=p.indexOf(e),o&&-1===t?p.push(e):!o&&-1<t&&p.splice(t,1))}):p.length=0,this.send("".concat(protocol.id).concat(p.length?p.join(","):"*"))},this.getId=function(){return p}}function Client(){var _this2=this,onerror=4<arguments.length&&"function"==typeof arguments[4]?arguments[4]:"object"===_typeof(arguments[0])&&"function"==typeof arguments[0].onerror?arguments[0].onerror:null,funcMap={},context=null,data={connectedCallbacks:[],type:"client",onmessage:function onmessage(_ref2){var data=_ref2.data,id=_ref2.id,msg;if(data.indexOf(protocol.script)){data.indexOf(protocol.error)||(msg=data.substr(protocol.error.length),onerror?onerror(new Error(msg)):console.error(msg))}else{var reg=new RegExp("^".concat(protocol.script).concat(idReg)),match=data.match(reg);if(match){var sid=match[1],script=match[2],result=void 0,send=function(e,t){var o="",o=e?"".concat(protocol.error).concat(e.message||"error"):("object"===_typeof(t)&&(t=JSON.stringify(t)),"".concat(protocol.result).concat(t));_this2.send("".concat(protocol.route).concat(sid,"/").concat(o,"#").concat(id))},bCalled=!1;try{var res=espree__namespace.parse(script),fnName,func,getValue,args;res.body.length&&res.body[0].expression.callee&&res.body[0].expression.callee.name&&(fnName=res.body[0].expression.callee.name,func=funcMap[fnName]||("function"==typeof window[fnName]?window[fnName]:null),func&&(getValue=function t(e){if(void 0!==e.properties){var o={};return e.properties.forEach(function(e){o[e.key.name]=t(e.value)}),o}if(void 0===e.elements)return e.value;var n=[];return e.elements.forEach(function(e){n.push(t(e))}),n},args=[],res.body[0].expression.arguments.forEach(function(e){args.push(getValue(e))}),result=func.apply(context,args),bCalled=!0))}catch(e){console.log(e.message||e)}if(!bCalled)try{result=eval(script)}catch(e){return console.error(e),void send(e)}result instanceof Promise?result.then(function(e){return send(null,e)}).catch(function(e){console.error(e),send(e)}):send(null,result)}}}};Base.apply(this,[].concat(Array.prototype.slice.call(arguments),[data])),this.register=function(e,t){"function"==typeof t&&(funcMap[e]=t)},this.remove=function(e,t){if(e)return delete funcMap[e];if("function"==typeof t)for(var o in funcMap)if(funcMap[o]===t)return delete funcMap[o];return!1},this.bind=function(e){"object"===_typeof(e)&&(context=e)}}function Master(){var o=4<arguments.length&&"function"==typeof arguments[4]?arguments[4]:"object"===_typeof(arguments[0])&&"function"==typeof arguments[0].onerror?arguments[0].onerror:null,r={},e={connectedCallbacks:[],type:"master",onmessage:function(e){var t=e.data,e=e.id;t.indexOf(protocol.result)||void 0!==r[e]&&r[e](t.substr(protocol.result.length)),t.indexOf(protocol.error)||(t=t.substr(protocol.error.length),t=new Error(t||"unknow error"),void 0!==r[e]&&r[e](null,t),o?o(t):console.error(t))}};Base.apply(this,[].concat(Array.prototype.slice.call(arguments),[e])),this.connect=this.setId,this.run=function(e,t){var o,n;1===this.readyState()&&(o=this.sessionId(),n=this.send("".concat(protocol.script).concat(o,"/").concat(e)),"function"==typeof t&&(r[n]=t,setTimeout(function(){delete r[n]},18e4)))}}Base.prototype.version=function(e){return e?this.send("".concat(protocol.version,"*")):version},Base.prototype.query=function(){return this.send2("".concat(protocol.query,"1")).then(function(e){return e.substr(protocol.query.length)})},Client.prototype=Base.prototype,Master.prototype=Base.prototype,exports.Client=Client,exports.Master=Master,Object.defineProperty(exports,"__esModule",{value:!0})});